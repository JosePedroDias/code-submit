<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">

        <title>code-submit basic test</title>

        <style type="text/css">
            body {
                font-family: sans-serif;

            }

            select {
                width: 60%;
                background-color: #FFF;
            }

            label {
                font-weight: bold;
                display: inline-block;
                vertical-align: top;
                width: 8em;
            }

            #problem {
                font-size: 0.8em;
            }

            #code {
                height: 400px;
                overflow: auto;
            }

            #code, #args, #expected-result, #feedback {
                font-family: monospace;
                font-size: 12px;
                width: 60%;
            }

            #feedback.error {
                color: red;
            }

            .hidden {
                display: none;
            }
        </style>

        <script type="text/javascript" src="http://rawgit.com/jakiestfu/Behave.js/master/behave.js"></script>
        <script type="text/javascript" src="http://spec.commonmark.org/dingus/commonmark.js"></script>
    </head>

    <body>
        <h1>code-submit</h1>

        <div>
            <button onclick="document.querySelector('#problem').classList.toggle('hidden')">toggle problem text</button>
            <div id="problem" class="hidden"></div>
        </div>

        <div id="interface">
            <label for="runtime">runtime:</label>
            <select id="runtime">
                <option value="js">JavaScript</option>
                <option value="py">Python</option>
                <option value="c">C</option>
            </select><br/>

            <label for="code">code:</label>
            <textarea id="code"></textarea><br/>

            <label for="args">arguments:</label>
            <input id="args" type="text" value=""><br/>

            <label for="expected-result">expected result:</label>
            <input id="expected-result" type="text" value=""><br/>

            <button id="run">run</button>

            <code><pre id="feedback"> </pre></code>
        </div>

        <script>
            //var SERVER = 'http://127.0.0.1:6662';
            var SERVER = 'http://stage.sl.pt:6662';



            var ajax = function(o) {
                var xhr = new XMLHttpRequest();
                xhr.open(o.verb || 'GET', o.uri, true);
                var cbInner = function() {
                    if (xhr.readyState === 4 && xhr.status > 199 && xhr.status < 300) {
                        return o.cb(null, JSON.parse(xhr.response));
                    }
                    o.cb('error requesting ' + o.uri);
                };
                xhr.onload  = cbInner;
                xhr.onerror = cbInner;
                xhr.send(o.payload || null);
            };

            var QS = function(sel) { return document.querySelector(sel); };



            var codes = {}; // to backup values locally on runtime change

            var problemEl = QS('#problem');
            var runtimeEl = QS('#runtime');
            var codeEl = QS('#code');
            var argsEl = QS('#args');
            var expectedResultEl = QS('#expected-result');
            var runEl = QS('#run');
            var feedbackEl = QS('#feedback');



            var renderer = window.commonmark.HtmlRenderer();
            var parser = window.commonmark.Parser();

            new Behave({textarea:codeEl});



            var lockUI = function(st) {
                runtimeEl.disabled = st;
                codeEl.disabled = st;
                argsEl.disabled = st;
                expectedResultEl.disabled = st;
                runEl.disabled = st;
            };

            var updateFeedback = function(content, isError) {
                feedbackEl.firstChild.nodeValue = content;
                feedbackEl.className = (isError ? 'error' : '');
            };



            runEl.addEventListener('click', function() { // request the code to be run remotely
                lockUI(true);
                var runtime = runtimeEl.value;
                var code = codeEl.value;
                var args = argsEl.value;
                var expectedResult = expectedResultEl.value;
                ajax({
                    uri : [SERVER,
                            '?runtime=',        encodeURIComponent(runtime),
                            '&args=',           encodeURIComponent(args),
                            '&expectedResult=', encodeURIComponent(expectedResult),
                        ].join(''),
                    verb: 'POST',
                    payload: code,
                    cb: function(err, o) {
                        lockUI(false);
                        if (err) { return window.alert(err); }
                        updateFeedback(o.err || o.out, !!o.err);
                    }
                });
                updateFeedback('running...');
            });



            runtimeEl.addEventListener('focus', function() { // backup code editor content
                codes[runtimeEl.value] = codeEl.value;
            });



            runtimeEl.addEventListener('change', function() { // restore code editor content
                codeEl.value = codes[ runtimeEl.value ] || '';
            });



            if (location.hash) { // if hash is set, get exercise data from gist at url http://gist.github.com/<ID>
                var hash = location.hash.substring(1);

                window.onGist = function(o) {
                    var files = o.data.files;
                    var text = files['text.md'].content;
                    var results = files['expectedResults'].content.split('\n');

                    for (var k in files) {
                        if (k.indexOf('skeleton.') !== 0) { continue; }
                        codes[ k.split('.')[1] ] = files[k].content;
                    }
                    var code = codes[ runtimeEl.value ];

                    codeEl.value = code;
                    argsEl.value = results[1];
                    expectedResultEl.value = results[2];
                    problemEl.innerHTML = renderer.render( parser.parse(text) );
                    problemEl.className = '';
                };

                var scriptEl = document.createElement('script'); // request gist via JSONP
                scriptEl.setAttribute('type', 'text/javascript');
                scriptEl.setAttribute('src', '//api.github.com/gists/' + hash +'?callback=onGist'); // 72bd1a23988fe753dbfd
                document.head.appendChild(scriptEl);
            }
            else {
                problemEl.parentNode.className = 'hidden';
            }
        </script>
    </body>
</html>
